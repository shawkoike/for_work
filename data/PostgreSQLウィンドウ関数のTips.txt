<p><a href="http://www.gab.lc/articles/window_functions_postgresql.php" rel="nofollow" title="" class="ext-link">Window Functions in PostgreSQL</a> by <a href="https://twitter.com/gabrielbordeaux" rel="nofollow" title="" class="ext-link">Gabriel Bordeaux</a></p><p>ウィンドウ関数はデータを処理する間、データの「ウィンドウ」を見ています。<br>
“現在のクエリ行に関連している行の集合を対象として計算を行う能力”を提供します。</p><p>簡単に言えば、PostgreSQLには現在11個のウィンドウ関数があります。</p><p><img src="http://www.gab.lc/img/window.png" class="aligncenter"></p><p>ウィンドウ関数を使用するためには、OVER()句で”ウィンドウ関数の構文”を用いる必要があります。サンプルテーブルを作成し、それを使って全てのウィンドウ関数に対する例を挙げてみましょう。<br>
この例では、14名の学生が居るクラスを管理しています。</p><p>これで学生リストのテーブルができました。</p><p>全てのウィンドウ関数にはOVER句が必要です。<br>
ウィンドウ関数は、クエリによって選択された行の一部（あるいは全ての行）を対象として機能します。OVER句を使って、その対象範囲を指定するのです。<br>
最初は、以下の例のようにOVER句の中でORDER BY句を単純に繰り返すことをお勧めします。</p><p>ご覧のとおり、このクエリは”a”列の順序で並べ替えられます。同じORDER BYがOVER句でも使われています。ウィンドウ関数を使いこなせるようになったら、少し時間をかけて<a href="http://www.postgresql.org/docs/9.3/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" rel="nofollow" title="" class="ext-link">ウィンドウ関数呼び出し</a>に関する公式のドキュメントを読んで、完全なOVER句構文を学んでください。</p><p>では、ウィンドウ関数をいくつか試してみましょう。</p><p>例えば、成績で並び替えて各行の数を知ることができます。</p><p>学生リスト内で、成績に応じて各学生の順位を求めることができます（同じ成績の2名は同じ順位になります）。</p><p>ご覧のとおり、2名が成績10で1位となり、次の2名が成績9で3位に居ます。</p><p>dense_rank()は<a href="#2">rank()</a>と似ていますが、順位間のギャップがありません（rank()では1位の次は3位でしたが、dense_rank()では2位になります）。</p><p>percent_rank()では、順位の”位置”ではなく、(rank – 1) / (全行数 – 1)という計算をして順位の割合を出します。</p><p>下の例では、Christopherは3位に居て14行あるので、percent_rank() = (3 – 2) / (14 – 1) = 2 / 13 = 0.153846153846154です。</p><p>学生リストは以下のようになります。</p><p>cume_dist()では(処理する行数) / (総行数)という計算式で相対順位を計算します。</p><p>ChristopherはJacobと並んで3位です。つまりChristopherと同じ順位、またはそれより上位の学生は4人（Christopher、Jacob、Ashley、Alexander）居て、全体では14行あります。</p><p>Christopherはcume_dist() = 4 / 14 = 0.285714285714286です。<br>
JacobはChristopherと同じ順位なので、cume_dist()の結果は同じものを得られるはずです。</p><p>学生リストは以下のようになります。</p><p>ntile()は行を等しい行数でバケットに分割します。もし10行を2バケットに分ける場合、各バケットには5行ずつとなります。<br>
学生を2つおよび4つのバケットに分割した例を示します。</p><p>もしntile()を気に入ったのであれば、PostgreSQLの関数である<a href="http://www.gab.lc/articles/weighted_ntile" rel="nofollow" title="" class="ext-link">Weighted_ntile</a>に関する私の記事を読んでみてください。重み付けされたグループでデータに順位を付ける方法を書いています。</p><p>lag()は現在の行より1つ以上前にある行の値を返します。</p><p>以下の例では、現在の行よりも1行または2行前にある学生の名前が表示されています。</p><p>lead()は、<a href="#7">lag()</a>の逆で、現在の行よりも1行以上後にある行の値を返します。</p><p>以下の例では現在行の1行または2行後の学生の名前が表示されています。</p><p>first_value()はウィンドウフレームの最初の行の値を返します。</p><p>例えば、クラスの中の最上位を見て現在の順位と最上位との差を計算できます。</p><p>last_value()はウィンドウフレームの最後の行の値を返します。<br>
公式のドキュメントでは、ウィンドウフレームはデフォルトで”パーティションの先頭から現在の行の最後ピアまで”が含まれるとあります。これではlast_valueとnth_valueでは有用ではない結果が得られがちです。以下の例のようにデータ範囲を指定することでこれを回避できます。</p><p>クラスの最下位を確認でき、また現在の順位と最下位との差を見ることができます。</p><p>nth_value()はウィンドウフレーム内のn番目の行を返します。<a href="#10">last_value()</a>と同様の制約があるため有用な結果を得るためにはデータの範囲を指定する必要があります。</p><p>例えば、以下は4位の学生（Jacob）の成績と8位の学生（Emily）の成績が表示されています。</p><p>ウィンドウ関数についてはPostgreSQLの公式Webページで詳細を読むことができます。<br>
関連ページはこちらです。<br>
・<a href="http://www.postgresql.org/docs/9.3/static/functions-window.html" rel="nofollow" title="" class="ext-link">汎用ウィンドウ関数</a><br>
・<a href="http://www.postgresql.org/docs/9.3/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" rel="nofollow" title="" class="ext-link">ウィンドウ関数呼び出し</a>（クエリによって選択された行部分に対する集約のような機能）</p>
