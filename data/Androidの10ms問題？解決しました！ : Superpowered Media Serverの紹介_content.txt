Android's 10 ms Problem? SOLVED. （2016-6-10） by Gabor Szanto, Superpowered私たちはとても人気のあるシリーズ記事の中で、Androidのオーディオアーキテクチャ問題を説明しました。どんなカテゴリのアプリも、粗悪で評判の悪いプラットフォームで作ってほしくないからです。そして、Android M（Marshmallow）の最近の進歩の記事では、新たな発見を更新し、最近ではAndroidのUSBオーディオとMIDI解決法の記事も発表しました。これにより、オーディオアプリのプロのクリエーターにデバイス11億台規模の市場を開放したこととなりました。私たちが行ってきた、4238種類以上のAndroidモデル/ビルドの、テストと技術分析とオーディオレイテンシ測定データベースにより、「Androidの往復オーディオレイテンシ問題の解決のため、Googleは大きな進歩を生んできた」ということを示しました。しかし、抜本的な変化がない限り、現在のメディアサーバ内部が劇的に改良される様子はないので、この進歩は今、スローダウンしているように思えます。今のところ、オーディオレイテンシに関して、Android Nには進展はないようです。私たちの元には世界中から毎日のように、Androidオーディオの10ms問題を解決してほしいと、開発者たちから懇願のメールが送られてきますが、ついに、Androidオーディオの10ms問題を解決し、今すぐにでもそれをダウンロードし試せるようになったことを、自信を持ってここに宣言いたします。
注釈：
タイトル：Androidの10ms問題？
8msにまで改善しました
Superpowered Android 6.0 Marshmallowを実行したGoogle Nexus 9における実際のレイテンシデータこの画像を埋め込みたい場合は、以下のコードをコピーしてください。往復オーディオレイテンシの低さを示すための、有用な定義は以下の通りです。＋オーディオインプット（時間）
＋オーディオプロセッシング（時間）
＋オーディオアウトプット（時間）
＝10ms以下人がアプリを自然に夢中になれると感じるには、インタラクションのレンテンシが10ms以下である必要があります。たとえ、あと数ms増えても、リスナーやアプリのユーザに不快感を与えてしまいます（理由までは分かりませんが、そういうふうに感じてしまうのです）。ここで知っておきたいのは、2007年にiPhoneが登場して、iOSはずっと低レイテンシを保っていることです。2016年6月現在で、公式に発表されているベストなAndroidのオーディオレイテンシは以下の数値になっています。
画像元なぜAndroidは低レイテンシでないかという疑問に関して、一番よくある誤解は、以下の3つに集中しています。私たちの研究開発によると、上記3つにはそれぞれに小さな問題は存在するものの、前述の問題は解決できず決定的な解決法とは言えません。Superpowered Incの公式見解では、これら3つに関しては完全に許容できる範囲としています。根本的には、Androidオーディオスタックが、基本的なアーキテクチャの問題を抱えているのです。Android誕生時の技術的な決め事から発生したものになります。これは、GoogleがAndroidを買収する前からの話です。Android向けのSuperpowered Media Serverと一体化したAndroidと、今までのAndroidの違いを比べるには、3つのオーディオパスでオーディオレイテンシを測定します。Huawei Nexus 6Pの往復オーディオレイテンシHTC Nexus9の往復オーディオレイテンシAndroid向けのSuperpowered Media ServerはAndroid HAL（オーディオドライバを扱う）とAndroidメディアサーバ（オーディオを扱うシステムコンポーネント）との間に挿入しています。これでアプリケーションはAndroidメディアサーバを回避することができるようになり、アプリに以下のような利益をもたらしています。Superpowered Media Serverはオーディオシステムのルーティングやシステムアプリケーション、通知、その他のAndroidのオーディオ機能には影響を与えません。このメディアサーバは既存のAndroidのオーディオ機能と100%互換性があり、オーディオ機能と関係のないアプリケーションには絶対に影響を与えません。分かりやすく言えば、Superpowered Media Serverと一緒にビルドされたAndroidではどんなアプリでも問題なく機能するということです。これは、アプリがSuperpowered Media Serverのオーディオパスを使用すると決めていてもいなくても同じです。Androidメディアサーバのすべての機能がそのまま使えるのです。最後に、Superpoweredオーディオのアクセスをどのアプリも要求しなければ、Superpowered Media ServerにCPUオーバーヘッドは発生しません。Superpowered Media Serverには以下の特徴があります。Superpowered Media ServerはHALを使用し、新しいやり方でユーザアプリケーションと接続します。今回の発表は、以下のことをお伝えするのが目的です。そして一番重要なのは、新しいSuperpowered Media Serverのオーディオパスは「プル型」として機能し、一方で既存のAndroidメディアサーバは「プッシュ型」であるということです。プル型を使うと、オーディオドライバが、メディアサーバとユーザアプリケーションが次のオーディオバッファを生成すべき時を指示します。一方でプッシュ型では、メディアサーバ、もしくはユーザアプリケーションが、オーディオドライバの準備ができていてもいなくでも、オーディオドライバに次のオーディオバッファを押し込みます。プッシュ型は、役割が逆転してしまっているのです。プル型はドロップアウトのリスクを小さくし、「オーディオデバイスのリズムの中で」オーディオを扱うので、Mac OSXのようなプロ向けのオーディオシステムの標準となっているのです。インストール手順は比較的簡単で、新たにAndroidをビルドする必要はありません。Androidのuserdebugビルド、またはroot化した運用ビルドならどれでもインストールすることができます。Superpowered Media Serverのデモは、現在、以下のデバイスをサポートしています。Samsung Galaxyデバイスにインストールすることは、お勧めしません。なぜなら、HAL/オーディオドライバが、Samsung Professional Audio SDKのオーディオショートカットをサポートするために、レイテンシをさらに増加させるからです。パッケージには以下のものが含まれています。Superpowered Media Serverオーディオパスを使用するために、利用可能な場合はレイテンシおよびオーディオ不具合測定アプリの修正版が用意されています。アクセスのリクエストには、mediaserver@superpowered.comにメールしてください。これは、完全な置き換えソリューションですか？
違います。Superpowered Media Serverは、Androidのサービススペースに埋め込まれ、AudioFlingerには全く手を付けません。ですから、正常な機能、軽微な統合、シームレスな動作、後方互換、およびパフォーマンスの向上が可能です。Superpowered Media Serverのオーディオ品質はスピードとトレードオフですか？
違います。Superpowered Media Serverは、10msを切る並外れたパフォーマンスを提供しながら、AndroidのAudioFlingerと全く同様に不具合やドロップアウトとは無縁です。Superpowered Media Serverは、Androidカーネルでよくあるカーネルスケジューリングの例外にどのように対処していますか？
Superpowered Media Serverは、AudioFlingerのサーバースレッドとOpenSL ESクライアントのオーディオプロセッシングスレッドと全く同じスレッドのスケジューリングポリシーを使用しています。
それはつまり、現状の解決方法と同じようにカーネルスケジューリングの例外に対処するということです。Superpowered Media Serverはスリープをどのように処理しますか？
Superpowered Media Serverは、プル方式を採用しています。AudioFlingerとは異なり、各状態間ではスリープしません。AudioFlingerは「プッシュ」方式で設計されているので、（入力オーディオや利用可能な出力バッファなどの）ALSAバッファイベントへの実際の接続を持っていません。Superpowered Media Serverのスレッドは、ALSAバッファイベントですぐにブロックが解除され、適切なスレッドスケジューリング設定と組み合わせると、クライアントがオーディオを処理したり入力したりするための最大処理時間を提供します。この方式は、ドロップアウトのリスクを減らし、もっぱら、Core Audioなどのリアルタイムプロオーディオシステムに使われています。OEMパートナーは、デバイスのHALまたはデバイスのハードウェアを変更する必要がありますか？
デバイスのHALまたはハードウェアの変更は必要ありません。Superpowered Media Serverは、他のデバイスオーディオ機能にどのような影響を与えますか？
システムサウンドなど他のオーディオ機能には影響を与えません。デバイスの機能は以前のまま動作します。どうやって入手できますか？
mediaserver@superpowered.comにメールしてください。Superpoweredとは？
私たちは、AndroidとiOS向けのSuperpowered Audio SDKを使用した1億5000万件以上のアプリインストールと何千ものアプリによって、アプリユーザスペースのオーディオレイテンシを低減しています。今度は、Superpowered Media ServerでAndroidのサービススペースのオーディオレイテンシを減らそうとしています。 
